<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Apache Flink 1.1-SNAPSHOT 中文文档: Working with State</title>
    <link rel="shortcut icon" href="/page/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/page/favicon.ico" type="image/x-icon">

    <!-- Bootstrap -->
    <link href="//cdn.bootcss.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/page/css/flink.css">
    <link rel="stylesheet" href="/page/css/syntax.css">
    <link rel="stylesheet" href="/page/css/codetabs.css">
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    
    





    <!-- Top navbar. -->
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <!-- The logo. -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <div class="navbar-logo">
            <a href="http://flink.apache.org"><img alt="Apache Flink" src="/page/img/navbar-brand-logo.jpg"></a>
          </div>
        </div><!-- /.navbar-header -->

        <!-- The navigation links. -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav">
            <li class="hidden-sm "><a href="/">中文文档 1.1</a></li>

            <li class="hidden-sm "><a href="/features.html">特性</a></li>

            <!-- Quickstart -->
            <li class="dropdown">
              <a href="/quickstart" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">快速起步<span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                
                
                <li class=""><a href="/quickstart/setup_quickstart.html">安装</a></li>
                
                <li class=""><a href="/quickstart/run_example_quickstart.html">运行实例</a></li>
                
                <li class=""><a href="/quickstart/java_api_quickstart.html">Java API</a></li>
                
                <li class=""><a href="/quickstart/scala_api_quickstart.html">Scala API</a></li>
                
              </ul>
            </li>

            <!-- Setup -->
            <li class="dropdown">
              <a href="/setup" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">安装 <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                
                
                <li class=""><a href="/setup/building.html">Build Flink from Source</a></li>
                
                <li class=""><a href="/setup/config.html">Configuration</a></li>
                

                <li class="divider"></li>
                <li role="presentation" class="dropdown-header"><strong>部署</strong></li>
                
                
                <li class=""><a href="/setup/local_setup.html">本地</a></li>
                
                <li class=""><a href="/setup/cluster_setup.html">集群 (Standalone)</a></li>
                
                <li class=""><a href="/setup/yarn_setup.html">YARN</a></li>
                
                <li class=""><a href="/setup/gce_setup.html">Google Compute Engine</a></li>
                
                <li class=""><a href="/setup/jobmanager_high_availability.html">High Availability</a></li>
                
              </ul>
            </li>

            <!-- Programming Guides -->
            <li class="dropdown active">
              <a href="/apis" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">编程指南 <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                
                
                <li class=""><a href="/apis/common/"><strong>基本概念</strong></a></li>
                
                <li class="active"><a href="/apis/streaming/"><strong>Streaming 指南</strong> (DataStream API)</a></li>
                
                <li class=""><a href="/apis/batch/"><strong>Batch Guide</strong> (DataSet API)</a></li>
                
                <li class=""><a href="/apis/best_practices.html">Best Practices</a></li>
                
                <li class=""><a href="/apis/cli.html">Command-Line Interface</a></li>
                
                <li class=""><a href="/apis/local_execution.html">Local Execution</a></li>
                
                <li class=""><a href="/apis/cluster_execution.html">Cluster Execution</a></li>
                
                <li class=""><a href="/apis/scala_shell.html">Scala Shell</a></li>
                
                <li class=""><a href="/apis/java8.html">Java 8</a></li>
                
              </ul>
            </li>

            <!-- Libraries -->
            <li class="dropdown">
              <a href="/libs" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">类库 <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
                  <li class=""><a href="/apis/batch/libs/gelly.html">Graphs: Gelly</a></li>
                  
                  <li class=""><a href="/apis/streaming/libs/cep.html">CEP</a></li>
                  
                  <li class=""><a href="/apis/batch/libs/ml/">Machine Learning</a></li>
                  
                  <li class=""><a href="/apis/batch/libs/table.html">Relational: Table</a></li>
                  
              </ul>
            </li>

            <!-- Internals -->
            <li class="dropdown">
              <a href="/internals" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">内部 <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                <li role="presentation" class="dropdown-header"><strong>Contribute</strong></li>
                <li><a href="http://flink.apache.org/how-to-contribute.html"><small><span class="glyphicon glyphicon-new-window"></span></small> How to Contribute</a></li>
                <li><a href="http://flink.apache.org/contribute-code.html#coding-guidelines"><small><span class="glyphicon glyphicon-new-window"></span></small> Coding Guidelines</a></li>
                
                
                <li class=""><a href="/internals/ide_setup.html">IDE Setup</a></li>
                
                <li class=""><a href="/internals/logging.html">Logging</a></li>
                
                <li class=""><a href="/internals/general_arch.html">Architecture and Process Model</a></li>
                
                <li class=""><a href="/internals/stream_checkpointing.html">Fault Tolerance for Data Streaming</a></li>
                
                <li class=""><a href="/internals/types_serialization.html">Type Extraction and Serialization</a></li>
                
                <li class=""><a href="/internals/monitoring_rest_api.html">Monitoring REST API</a></li>
                
                <li class=""><a href="/internals/job_scheduling.html">Jobs and Scheduling</a></li>
                
                <li class=""><a href="/internals/add_operator.html">How-To: Add an Operator</a></li>
                
              </ul>
            </li>

          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li><a class="hidden-sm" href="http://blog.flink-china.org" target="_blank">
            <small><span class="glyphicon glyphicon-new-window"></span></small> 博客</a></li>
            <li class="hidden-sm "><a href="/about/">关于本站</a></li>
          </ul>
          <form class="navbar-form navbar-right hidden-sm hidden-md" role="search" action="/search-results.html">
            <div class="form-group">
              <input type="text" class="form-control" size="16px" name="q" placeholder="Search all pages">
            </div>
            <button type="submit" class="btn btn-default">搜索</button>
          </form>
        </div><!-- /.navbar-collapse -->
      </div><!-- /.container -->
    </nav>


    

    <!-- Main content. -->
    <div class="container">
      
      
<div class="row">


  <!-- Sub Navigation -->
  <div class="col-sm-3">
    <ul id="sub-nav">
      
      
      
        
        <li><a href="/apis/streaming/" class="active">DataStream API</a>
          
        </li>
      
        
        <li><a href="/apis/streaming/event_time.html" class="">Event Time</a>
          
          <ul>
            
              <li><a href="/apis/streaming/event_timestamps_watermarks.html" class="">Generating Timestamps / Watermarks</a></li>
            
          </ul>
          
        </li>
      
        
        <li><a href="/apis/streaming/windows.html" class="">Windows</a>
          
          <ul>
            
              <li><a href="/apis/streaming/time.html" class="">Working with Time</a></li>
            
          </ul>
          
        </li>
      
        
        <li><a href="/apis/streaming/fault_tolerance.html" class="">Fault Tolerance</a>
          
          <ul>
            
              <li><a href="/apis/streaming/state.html" class="active">Working with State</a></li>
            
              <li><a href="/apis/streaming/state_backends.html" class="">State Backends</a></li>
            
          </ul>
          
        </li>
      
        
        <li><a href="/apis/streaming/savepoints.html" class="">Savepoints</a>
          
        </li>
      
        
        <li><a href="/apis/streaming/connectors/" class="">Connectors</a>
          
          <ul>
            
              <li><a href="/apis/streaming/connectors/kafka.html" class="">Kafka</a></li>
            
              <li><a href="/apis/streaming/connectors/elasticsearch.html" class="">Elasticsearch</a></li>
            
              <li><a href="/apis/streaming/connectors/hdfs.html" class="">HDFS</a></li>
            
              <li><a href="/apis/streaming/connectors/rabbitmq.html" class="">RabbitMQ</a></li>
            
              <li><a href="/apis/streaming/connectors/twitter.html" class="">Twitter</a></li>
            
          </ul>
          
        </li>
      
        
        <li><a href="/apis/streaming/libs/" class="">Libraries</a>
          
          <ul>
            
              <li><a href="/apis/streaming/libs/cep.html" class="">Event Processing (CEP)</a></li>
            
          </ul>
          
        </li>
      
        
        <li><a href="/apis/streaming/storm_compatibility.html" class="">Storm Compatibility</a>
          
        </li>
      
    </ul>
  </div>
  <!-- Main -->
  <div class="col-sm-9">
    <!-- Top anchor -->
    <a href="#top"></a>

    <!-- Artifact name change warning. Remove for the 1.0 release. -->
    
    <div class="panel panel-default">
      <div class="panel-body"><strong>重要</strong>: 依赖于Scala的maven artifacts现在会添加一个Scala主版本的后缀，例如 "2.10" 或 "2.11". 请查阅<a href="https://cwiki.apache.org/confluence/display/FLINK/Maven+artifact+names+suffixed+with+Scala+version">迁移指南</a>.</div>
    </div>
    

    <!-- Breadcrumbs above the main heading -->
    <ol class="breadcrumb">
      
      
      <li><a href="/apis/streaming/">Streaming 指南</a></li>
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      

      
      
      

      

      <li><a href="/apis/streaming/fault_tolerance.html">Fault Tolerance</a></li>
      
      
      <li class="active">Working with State</li>
    </ol>

    <div class="text">
      <!-- Main heading -->
      <h1>Working with State</h1>

      <!-- Content -->
      

<p>All transformations in Flink may look like functions (in the functional processing terminology), but
are in fact stateful operators. You can make <em>every</em> transformation (<code>map</code>, <code>filter</code>, etc) stateful
by using Flink’s state interface or checkpointing instance fields of your function. You can register
any instance field
as <strong><em>managed</em></strong> state by implementing an interface. In this case, and also in the case of using
Flink’s native state interface, Flink will automatically take consistent snapshots of your state
periodically, and restore its value in the case of a failure.</p>

<p>The end effect is that updates to any form of state are the same under failure-free execution and
execution under failures.</p>

<p>First, we look at how to make instance fields consistent under failures, and then we look at
Flink’s state interface.</p>

<p>By default state checkpoints will be stored in-memory at the JobManager. For proper persistence of large
state, Flink supports storing the checkpoints on file systems (HDFS, S3, or any mounted POSIX file system),
which can be configured in the <code>flink-conf.yaml</code> or via <code>StreamExecutionEnvironment.setStateBackend(…)</code>.
See <a href="/apis/streaming/state_backends.html">state backends</a> for information
about the available state backends and how to configure them.</p>

<ul id="markdown-toc">
  <li><a href="#using-the-keyvalue-state-interface" id="markdown-toc-using-the-keyvalue-state-interface">Using the Key/Value State Interface</a>    <ul>
      <li><a href="#state-in-the-scala-datastream-api" id="markdown-toc-state-in-the-scala-datastream-api">State in the Scala DataStream API</a></li>
    </ul>
  </li>
  <li><a href="#checkpointing-instance-fields" id="markdown-toc-checkpointing-instance-fields">Checkpointing Instance Fields</a></li>
  <li><a href="#stateful-source-functions" id="markdown-toc-stateful-source-functions">Stateful Source Functions</a></li>
  <li><a href="#state-checkpoints-in-iterative-jobs" id="markdown-toc-state-checkpoints-in-iterative-jobs">State Checkpoints in Iterative Jobs</a></li>
</ul>

<h2 id="using-the-keyvalue-state-interface">Using the Key/Value State Interface</h2>

<p>The Key/Value state interface provides access to different types of state that are all scoped to
the key of the current input element. This means that this type of state can only be used
on a <code>KeyedStream</code>, which can be created via <code>stream.keyBy(…)</code>.</p>

<p>Now, we will first look at the different types of state available and then we will see
how they can be used in a program. The available state primitives are:</p>

<ul>
  <li>
    <p><code>ValueState&lt;T&gt;</code>: This keeps a value that can be updated and
retrieved (scoped to key of the input element, mentioned above, so there will possibly be one value
for each key that the operation sees). The value can be set using <code>update(T)</code> and retrieved using
<code>T value()</code>.</p>
  </li>
  <li>
    <p><code>ListState&lt;T&gt;</code>: This keeps a list of elements. You can append elements and retrieve an <code>Iterable</code>
over all currently stored elements. Elements are added using <code>add(T)</code>, the Iterable can
be retrieved using <code>Iterable&lt;T&gt; get()</code>.</p>
  </li>
  <li>
    <p><code>ReducingState&lt;T&gt;</code>: This keeps a single value that represents the aggregation of all values
added to the state. The interface is the same as for <code>ListState</code> but elements added using
<code>add(T)</code> are reduced to an aggregate using a specified <code>ReduceFunction</code>.</p>
  </li>
</ul>

<p>All types of state also have a method <code>clear()</code> that clears the state for the currently
active key (i.e. the key of the input element).</p>

<p>It is important to keep in mind that these state objects are only used for interfacing
with state. The state is not necessarily stored inside but might reside on disk or somewhere else.
The second thing to keep in mind is that the value you get from the state
depend on the key of the input element. So the value you get in one invocation of your
user function can be different from the one you get in another invocation if the key of
the element is different.</p>

<p>To get a state handle you have to create a <code>StateDescriptor</code> this holds the name of the state
(as we will later see you can create several states, and they have to have unique names so
that you can reference them), the type of the values that the state holds and possibly
a user-specified function, such as a <code>ReduceFunction</code>. Depending on what type of state you
want to retrieve you create one of <code>ValueStateDescriptor</code>, <code>ListStateDescriptor</code> or
<code>ReducingStateDescriptor</code>.</p>

<p>State is accessed using the <code>RuntimeContext</code>, so it is only possible in <em>rich functions</em>.
Please see <a href="/apis/common/#specifying-transformation-functions">here</a> for
information about that but we will also see an example shortly. The <code>RuntimeContext</code> that
is available in a <code>RichFunction</code> has these methods for accessing state:</p>

<ul>
  <li><code>ValueState&lt;T&gt; getState(ValueStateDescriptor&lt;T&gt;)</code></li>
  <li><code>ReducingState&lt;T&gt; getReducingState(ReducingStateDescriptor&lt;T&gt;)</code></li>
  <li><code>ListState&lt;T&gt; getListState(ListStateDescriptor&lt;T&gt;)</code></li>
</ul>

<p>This is an example <code>FlatMapFunction</code> that shows how all of the parts fit together:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CountWindowAverage</span> <span class="kd">extends</span> <span class="n">RichFlatMapFunction</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;,</span> <span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;&gt;</span> <span class="o">{</span>

    <span class="cm">/**</span>
<span class="cm">     * The ValueState handle. The first field is the count, the second field a running sum.</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">transient</span> <span class="n">ValueState</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;&gt;</span> <span class="n">sum</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">flatMap</span><span class="o">(</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="n">input</span><span class="o">,</span> <span class="n">Collector</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;&gt;</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>

        <span class="c1">// access the state value</span>
        <span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="n">currentSum</span> <span class="o">=</span> <span class="n">sum</span><span class="o">.</span><span class="na">value</span><span class="o">();</span>

        <span class="c1">// update the count</span>
        <span class="n">currentSum</span><span class="o">.</span><span class="na">f0</span> <span class="o">+=</span> <span class="mi">1</span><span class="o">;</span>

        <span class="c1">// add the second field of the input value</span>
        <span class="n">currentSum</span><span class="o">.</span><span class="na">f1</span> <span class="o">+=</span> <span class="n">input</span><span class="o">.</span><span class="na">f1</span><span class="o">;</span>

        <span class="c1">// update the state</span>
        <span class="n">sum</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">currentSum</span><span class="o">);</span>

        <span class="c1">// if the count reaches 2, emit the average and clear the state</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">currentSum</span><span class="o">.</span><span class="na">f0</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">out</span><span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="k">new</span> <span class="n">Tuple2</span><span class="o">&lt;&gt;(</span><span class="n">input</span><span class="o">.</span><span class="na">f0</span><span class="o">,</span> <span class="n">currentSum</span><span class="o">.</span><span class="na">f1</span> <span class="o">/</span> <span class="n">currentSum</span><span class="o">.</span><span class="na">f0</span><span class="o">));</span>
            <span class="n">sum</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">open</span><span class="o">(</span><span class="n">Configuration</span> <span class="n">config</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ValueStateDescriptor</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;&gt;</span> <span class="n">descriptor</span> <span class="o">=</span>
                <span class="k">new</span> <span class="n">ValueStateDescriptor</span><span class="o">&lt;&gt;(</span>
                        <span class="s">&quot;average&quot;</span><span class="o">,</span> <span class="c1">// the state name</span>
                        <span class="n">TypeInformation</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="k">new</span> <span class="n">TypeHint</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;&gt;()</span> <span class="o">{}),</span> <span class="c1">// type information</span>
                        <span class="n">Tuple2</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">0L</span><span class="o">,</span> <span class="mi">0L</span><span class="o">));</span> <span class="c1">// default value of the state, if nothing was set</span>
        <span class="n">sum</span> <span class="o">=</span> <span class="n">getRuntimeContext</span><span class="o">().</span><span class="na">getState</span><span class="o">(</span><span class="n">descriptor</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// this can be used in a streaming program like this (assuming we have a StreamExecutionEnvironment env)</span>
<span class="n">env</span><span class="o">.</span><span class="na">fromElements</span><span class="o">(</span><span class="n">Tuple2</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="mi">3L</span><span class="o">),</span> <span class="n">Tuple2</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="mi">5L</span><span class="o">),</span> <span class="n">Tuple2</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="mi">7L</span><span class="o">),</span> <span class="n">Tuple2</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="mi">4L</span><span class="o">),</span> <span class="n">Tuple2</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="mi">2L</span><span class="o">))</span>
        <span class="o">.</span><span class="na">keyBy</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
        <span class="o">.</span><span class="na">flatMap</span><span class="o">(</span><span class="k">new</span> <span class="nf">CountWindowAverage</span><span class="o">())</span>
        <span class="o">.</span><span class="na">print</span><span class="o">();</span>

<span class="c1">// the printed output will be (1,4) and (1,5)</span></code></pre></figure>

<p>This example implements a poor man’s counting window. We key the tuples by the first field
(in the example all have the same key <code>1</code>). The function stores the count and a running sum in
a <code>ValueState</code>, once the count reaches 2 it will emit the average and clear the state so that
we start over from <code>0</code>. Note that this would keep a different state value for each different input
key if we had tuples with different values in the first field.</p>

<h3 id="state-in-the-scala-datastream-api">State in the Scala DataStream API</h3>

<p>In addition to the interface described above, the Scala API has shortcuts for stateful
<code>map()</code> or <code>flatMap()</code> functions with a single <code>ValueState</code> on <code>KeyedStream</code>. The user function
gets the current value of the <code>ValueState</code> in an <code>Option</code> and must return an updated value that
will be used to update the state.</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">stream</span><span class="k">:</span> <span class="kt">DataStream</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">Int</span><span class="o">)]</span> <span class="k">=</span> <span class="o">...</span>

<span class="k">val</span> <span class="n">counts</span><span class="k">:</span> <span class="kt">DataStream</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">Int</span><span class="o">)]</span> <span class="k">=</span> <span class="n">stream</span>
  <span class="o">.</span><span class="n">keyBy</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">_1</span><span class="o">)</span>
  <span class="o">.</span><span class="n">mapWithState</span><span class="o">((</span><span class="n">in</span><span class="k">:</span> <span class="o">(</span><span class="kt">String</span><span class="o">,</span> <span class="kt">Int</span><span class="o">),</span> <span class="n">count</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">Int</span><span class="o">])</span> <span class="k">=&gt;</span>
    <span class="n">count</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">c</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">(</span> <span class="o">(</span><span class="n">in</span><span class="o">.</span><span class="n">_1</span><span class="o">,</span> <span class="n">c</span><span class="o">),</span> <span class="nc">Some</span><span class="o">(</span><span class="n">c</span> <span class="o">+</span> <span class="n">in</span><span class="o">.</span><span class="n">_2</span><span class="o">)</span> <span class="o">)</span>
      <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span> <span class="o">(</span> <span class="o">(</span><span class="n">in</span><span class="o">.</span><span class="n">_1</span><span class="o">,</span> <span class="mi">0</span><span class="o">),</span> <span class="nc">Some</span><span class="o">(</span><span class="n">in</span><span class="o">.</span><span class="n">_2</span><span class="o">)</span> <span class="o">)</span>
    <span class="o">})</span></code></pre></figure>

<h2 id="checkpointing-instance-fields">Checkpointing Instance Fields</h2>

<p>Instance fields can be checkpointed by using the <code>Checkpointed</code> interface.</p>

<p>When the user-defined function implements the <code>Checkpointed</code> interface, the <code>snapshotState(…)</code> and <code>restoreState(…)</code>
methods will be executed to draw and restore function state.</p>

<p>In addition to that, user functions can also implement the <code>CheckpointNotifier</code> interface to receive notifications on
completed checkpoints via the <code>notifyCheckpointComplete(long checkpointId)</code> method.
Note that there is no guarantee for the user function to receive a notification if a failure happens between
checkpoint completion and notification. The notifications should hence be treated in a way that notifications from
later checkpoints can subsume missing notifications.</p>

<p>The above example for <code>ValueState</code> can be implemented using instance fields like this:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CountWindowAverage</span>
        <span class="kd">extends</span> <span class="n">RichFlatMapFunction</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;,</span> <span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;&gt;</span>
        <span class="kd">implements</span> <span class="n">Checkpointed</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="n">sum</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">flatMap</span><span class="o">(</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="n">input</span><span class="o">,</span> <span class="n">Collector</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;&gt;</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>

        <span class="c1">// update the count</span>
        <span class="n">sum</span><span class="o">.</span><span class="na">f0</span> <span class="o">+=</span> <span class="mi">1</span><span class="o">;</span>

        <span class="c1">// add the second field of the input value</span>
        <span class="n">sum</span><span class="o">.</span><span class="na">f1</span> <span class="o">+=</span> <span class="n">input</span><span class="o">.</span><span class="na">f1</span><span class="o">;</span>


        <span class="c1">// if the count reaches 2, emit the average and clear the state</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">sum</span><span class="o">.</span><span class="na">f0</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">out</span><span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="k">new</span> <span class="n">Tuple2</span><span class="o">&lt;&gt;(</span><span class="n">input</span><span class="o">.</span><span class="na">f0</span><span class="o">,</span> <span class="n">sum</span><span class="o">.</span><span class="na">f1</span> <span class="o">/</span> <span class="n">sum</span><span class="o">.</span><span class="na">f0</span><span class="o">));</span>
            <span class="n">sum</span> <span class="o">=</span> <span class="n">Tuple2</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">0L</span><span class="o">,</span> <span class="mi">0L</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">open</span><span class="o">(</span><span class="n">Configuration</span> <span class="n">config</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">sum</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// only recreate if null</span>
            <span class="c1">// restoreState will be called before open()</span>
            <span class="c1">// so this will already set the sum to the restored value</span>
            <span class="n">sum</span> <span class="o">=</span> <span class="n">Tuple2</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">0L</span><span class="o">,</span> <span class="mi">0L</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// regularly persists state during normal operation</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Serializable</span> <span class="nf">snapshotState</span><span class="o">(</span><span class="kt">long</span> <span class="n">checkpointId</span><span class="o">,</span> <span class="kt">long</span> <span class="n">checkpointTimestamp</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">sum</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// restores state on recovery from failure</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">restoreState</span><span class="o">(</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="n">state</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">sum</span> <span class="o">=</span> <span class="n">state</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<h2 id="stateful-source-functions">Stateful Source Functions</h2>

<p>Stateful sources require a bit more care as opposed to other operators.
In order to make the updates to the state and output collection atomic (required for exactly-once semantics
on failure/recovery), the user is required to get a lock from the source’s context.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">CounterSource</span>
        <span class="kd">extends</span> <span class="n">RichParallelSourceFunction</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span>
        <span class="kd">implements</span> <span class="n">Checkpointed</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="cm">/**  current offset for exactly once semantics */</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">offset</span><span class="o">;</span>

    <span class="cm">/** flag for job cancellation */</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">isRunning</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(</span><span class="n">SourceContext</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">Object</span> <span class="n">lock</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">getCheckpointLock</span><span class="o">();</span>

        <span class="k">while</span> <span class="o">(</span><span class="n">isRunning</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// output and state update are atomic</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">ctx</span><span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">offset</span><span class="o">);</span>
                <span class="n">offset</span> <span class="o">+=</span> <span class="mi">1</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">cancel</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">isRunning</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Long</span> <span class="nf">snapshotState</span><span class="o">(</span><span class="kt">long</span> <span class="n">checkpointId</span><span class="o">,</span> <span class="kt">long</span> <span class="n">checkpointTimestamp</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">offset</span><span class="o">;</span>

    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">restoreState</span><span class="o">(</span><span class="n">Long</span> <span class="n">state</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">state</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>Some operators might need the information when a checkpoint is fully acknowledged by Flink to communicate that with the outside world. In this case see the <code>flink.streaming.api.checkpoint.CheckpointNotifier</code> interface.</p>

<h2 id="state-checkpoints-in-iterative-jobs">State Checkpoints in Iterative Jobs</h2>

<p>Flink currently only provides processing guarantees for jobs without iterations. Enabling checkpointing on an iterative job causes an exception. In order to force checkpointing on an iterative program the user needs to set a special flag when enabling checkpointing: <code>env.enableCheckpointing(interval, force = true)</code>.</p>

<p>Please note that records in flight in the loop edges (and the state changes associated with them) will be lost during failure.</p>

<p><a href="#top" class="top pull-right"><span class="glyphicon glyphicon-chevron-up"></span> Back to top</a></p>

      <div class="footer">
      发现错误？想参与编辑？
      <a href="https://github.com/wuchong/flink-china-doc/edit/master/apis/streaming/state.md" target="_blank">
        在 Github 上编辑此页！
      </a>
    </div>
    </div>
  </div>

  
</div>

    </div><!-- /.container -->

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="//cdn.bootcss.com/jquery/1.11.2/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="//cdn.bootcss.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="//cdn.bootcss.com/anchor-js/3.1.0/anchor.min.js"></script>
    <script src="/page/js/flink.js"></script>

    <!-- Google Analytics -->
    <!-- script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-52545728-1', 'auto');
      ga('send', 'pageview');
    </script -->

    <!-- Baidu Analytics -->
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?835985ad7943d8c24bc3c1f155b7d4a2";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
    </script>


    <!-- Disqus -->
    
  </body>
</html>
