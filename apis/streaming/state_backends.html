<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Apache Flink 1.1-SNAPSHOT 中文文档: State Backends</title>
    <link rel="shortcut icon" href="/page/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/page/favicon.ico" type="image/x-icon">

    <!-- Bootstrap -->
    <link href="//cdn.bootcss.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/page/css/flink.css">
    <link rel="stylesheet" href="/page/css/syntax.css">
    <link rel="stylesheet" href="/page/css/codetabs.css">
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    
    





    <!-- Top navbar. -->
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <!-- The logo. -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <div class="navbar-logo">
            <a href="http://flink.apache.org"><img alt="Apache Flink" src="/page/img/navbar-brand-logo.jpg"></a>
          </div>
        </div><!-- /.navbar-header -->

        <!-- The navigation links. -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav">
            <li class="hidden-sm "><a href="/">中文文档 1.1</a></li>

            <li class="hidden-sm "><a href="/features.html">特性</a></li>

            <!-- Quickstart -->
            <li class="dropdown">
              <a href="/quickstart" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">快速起步<span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                
                
                <li class=""><a href="/quickstart/setup_quickstart.html">安装</a></li>
                
                <li class=""><a href="/quickstart/run_example_quickstart.html">运行实例</a></li>
                
                <li class=""><a href="/quickstart/java_api_quickstart.html">Java API</a></li>
                
                <li class=""><a href="/quickstart/scala_api_quickstart.html">Scala API</a></li>
                
              </ul>
            </li>

            <!-- Setup -->
            <li class="dropdown">
              <a href="/setup" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">安装 <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                
                
                <li class=""><a href="/setup/building.html">Build Flink from Source</a></li>
                
                <li class=""><a href="/setup/config.html">Configuration</a></li>
                

                <li class="divider"></li>
                <li role="presentation" class="dropdown-header"><strong>部署</strong></li>
                
                
                <li class=""><a href="/setup/local_setup.html">本地</a></li>
                
                <li class=""><a href="/setup/cluster_setup.html">集群 (Standalone)</a></li>
                
                <li class=""><a href="/setup/yarn_setup.html">YARN</a></li>
                
                <li class=""><a href="/setup/gce_setup.html">Google Compute Engine</a></li>
                
                <li class=""><a href="/setup/jobmanager_high_availability.html">High Availability</a></li>
                
              </ul>
            </li>

            <!-- Programming Guides -->
            <li class="dropdown active">
              <a href="/apis" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">编程指南 <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                
                
                <li class=""><a href="/apis/common/"><strong>基本概念</strong></a></li>
                
                <li class="active"><a href="/apis/streaming/"><strong>Streaming 指南</strong> (DataStream API)</a></li>
                
                <li class=""><a href="/apis/batch/"><strong>Batch Guide</strong> (DataSet API)</a></li>
                
                <li class=""><a href="/apis/best_practices.html">Best Practices</a></li>
                
                <li class=""><a href="/apis/cli.html">Command-Line Interface</a></li>
                
                <li class=""><a href="/apis/local_execution.html">Local Execution</a></li>
                
                <li class=""><a href="/apis/cluster_execution.html">Cluster Execution</a></li>
                
                <li class=""><a href="/apis/scala_shell.html">Scala Shell</a></li>
                
                <li class=""><a href="/apis/java8.html">Java 8</a></li>
                
              </ul>
            </li>

            <!-- Libraries -->
            <li class="dropdown">
              <a href="/libs" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">类库 <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
                  <li class=""><a href="/apis/batch/libs/gelly.html">Graphs: Gelly</a></li>
                  
                  <li class=""><a href="/apis/streaming/libs/cep.html">CEP</a></li>
                  
                  <li class=""><a href="/apis/batch/libs/ml/">Machine Learning</a></li>
                  
                  <li class=""><a href="/apis/batch/libs/table.html">Relational: Table</a></li>
                  
              </ul>
            </li>

            <!-- Internals -->
            <li class="dropdown">
              <a href="/internals" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">内部 <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                <li role="presentation" class="dropdown-header"><strong>Contribute</strong></li>
                <li><a href="http://flink.apache.org/how-to-contribute.html"><small><span class="glyphicon glyphicon-new-window"></span></small> How to Contribute</a></li>
                <li><a href="http://flink.apache.org/contribute-code.html#coding-guidelines"><small><span class="glyphicon glyphicon-new-window"></span></small> Coding Guidelines</a></li>
                
                
                <li class=""><a href="/internals/ide_setup.html">IDE Setup</a></li>
                
                <li class=""><a href="/internals/logging.html">Logging</a></li>
                
                <li class=""><a href="/internals/general_arch.html">Architecture and Process Model</a></li>
                
                <li class=""><a href="/internals/stream_checkpointing.html">Fault Tolerance for Data Streaming</a></li>
                
                <li class=""><a href="/internals/types_serialization.html">Type Extraction and Serialization</a></li>
                
                <li class=""><a href="/internals/monitoring_rest_api.html">Monitoring REST API</a></li>
                
                <li class=""><a href="/internals/job_scheduling.html">Jobs and Scheduling</a></li>
                
                <li class=""><a href="/internals/add_operator.html">How-To: Add an Operator</a></li>
                
              </ul>
            </li>

          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li><a class="hidden-sm" href="http://blog.flink-china.org" target="_blank">
            <small><span class="glyphicon glyphicon-new-window"></span></small> 博客</a></li>
            <li class="hidden-sm "><a href="/about/">关于本站</a></li>
          </ul>
          <form class="navbar-form navbar-right hidden-sm hidden-md" role="search" action="/search-results.html">
            <div class="form-group">
              <input type="text" class="form-control" size="16px" name="q" placeholder="Search all pages">
            </div>
            <button type="submit" class="btn btn-default">搜索</button>
          </form>
        </div><!-- /.navbar-collapse -->
      </div><!-- /.container -->
    </nav>


    

    <!-- Main content. -->
    <div class="container">
      
      
<div class="row">


  <!-- Sub Navigation -->
  <div class="col-sm-3">
    <ul id="sub-nav">
      
      
      
        
        <li><a href="/apis/streaming/" class="active">DataStream API</a>
          
        </li>
      
        
        <li><a href="/apis/streaming/event_time.html" class="">Event Time</a>
          
          <ul>
            
              <li><a href="/apis/streaming/event_timestamps_watermarks.html" class="">Generating Timestamps / Watermarks</a></li>
            
          </ul>
          
        </li>
      
        
        <li><a href="/apis/streaming/windows.html" class="">Windows</a>
          
          <ul>
            
              <li><a href="/apis/streaming/time.html" class="">Working with Time</a></li>
            
          </ul>
          
        </li>
      
        
        <li><a href="/apis/streaming/fault_tolerance.html" class="">Fault Tolerance</a>
          
          <ul>
            
              <li><a href="/apis/streaming/state.html" class="">Working with State</a></li>
            
              <li><a href="/apis/streaming/state_backends.html" class="active">State Backends</a></li>
            
          </ul>
          
        </li>
      
        
        <li><a href="/apis/streaming/savepoints.html" class="">Savepoints</a>
          
        </li>
      
        
        <li><a href="/apis/streaming/connectors/" class="">Connectors</a>
          
          <ul>
            
              <li><a href="/apis/streaming/connectors/kafka.html" class="">Kafka</a></li>
            
              <li><a href="/apis/streaming/connectors/elasticsearch.html" class="">Elasticsearch</a></li>
            
              <li><a href="/apis/streaming/connectors/hdfs.html" class="">HDFS</a></li>
            
              <li><a href="/apis/streaming/connectors/rabbitmq.html" class="">RabbitMQ</a></li>
            
              <li><a href="/apis/streaming/connectors/twitter.html" class="">Twitter</a></li>
            
          </ul>
          
        </li>
      
        
        <li><a href="/apis/streaming/libs/" class="">Libraries</a>
          
          <ul>
            
              <li><a href="/apis/streaming/libs/cep.html" class="">Event Processing (CEP)</a></li>
            
          </ul>
          
        </li>
      
        
        <li><a href="/apis/streaming/storm_compatibility.html" class="">Storm Compatibility</a>
          
        </li>
      
    </ul>
  </div>
  <!-- Main -->
  <div class="col-sm-9">
    <!-- Top anchor -->
    <a href="#top"></a>

    <!-- Artifact name change warning. Remove for the 1.0 release. -->
    
    <div class="panel panel-default">
      <div class="panel-body"><strong>重要</strong>: 依赖于Scala的maven artifacts现在会添加一个Scala主版本的后缀，例如 "2.10" 或 "2.11". 请查阅<a href="https://cwiki.apache.org/confluence/display/FLINK/Maven+artifact+names+suffixed+with+Scala+version">迁移指南</a>.</div>
    </div>
    

    <!-- Breadcrumbs above the main heading -->
    <ol class="breadcrumb">
      
      
      <li><a href="/apis/streaming/">Streaming 指南</a></li>
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      

      
      
      

      

      <li><a href="/apis/streaming/fault_tolerance.html">Fault Tolerance</a></li>
      
      
      <li class="active">State Backends</li>
    </ol>

    <div class="text">
      <!-- Main heading -->
      <h1>State Backends</h1>

      <!-- Content -->
      

<p>Programs written in the <a href="index.html">Data Stream API</a> often hold state in various forms:</p>

<ul>
  <li>Windows gather elements or aggregates until they are triggered</li>
  <li>Transformation functions may use the key/value state interface to store values</li>
  <li>Transformation functions may implement the <code>Checkpointed</code> interface to make their local variables fault tolerant</li>
</ul>

<p>See also <a href="state.html">Working with State</a> in the streaming API guide.</p>

<p>When checkpointing is activated, such state is persisted upon checkpoints to guard against data loss and recover consistently.
How the state is represented internally, and how and where it is persisted upon checkpoints depends on the
chosen <strong>State Backend</strong>.</p>

<ul id="markdown-toc">
  <li><a href="#available-state-backends" id="markdown-toc-available-state-backends">Available State Backends</a>    <ul>
      <li><a href="#the-memorystatebackend" id="markdown-toc-the-memorystatebackend">The MemoryStateBackend</a></li>
      <li><a href="#the-fsstatebackend" id="markdown-toc-the-fsstatebackend">The FsStateBackend</a></li>
      <li><a href="#the-rocksdbstatebackend" id="markdown-toc-the-rocksdbstatebackend">The RocksDBStateBackend</a></li>
    </ul>
  </li>
  <li><a href="#configuring-a-state-backend" id="markdown-toc-configuring-a-state-backend">Configuring a State Backend</a>    <ul>
      <li><a href="#setting-the-per-job-state-backend" id="markdown-toc-setting-the-per-job-state-backend">Setting the Per-job State Backend</a></li>
      <li><a href="#setting-default-state-backend" id="markdown-toc-setting-default-state-backend">Setting Default State Backend</a></li>
    </ul>
  </li>
</ul>

<h2 id="available-state-backends">Available State Backends</h2>

<p>Out of the box, Flink bundles these state backends:</p>

<ul>
  <li><em>MemoryStateBacked</em></li>
  <li><em>FsStateBackend</em></li>
  <li><em>RocksDBStateBackend</em></li>
</ul>

<p>If nothing else is configured, the system will use the MemoryStateBacked.</p>

<h3 id="the-memorystatebackend">The MemoryStateBackend</h3>

<p>The <em>MemoryStateBacked</em> holds data internally as objects on the Java heap. Key/value state and window operators hold hash tables
that store the values, triggers, etc.</p>

<p>Upon checkpoints, this state backend will snapshot the state and send it as part of the checkpoint acknowledgement messages to the
JobManager (master), which stores it on its heap as well.</p>

<p>Limitations of the MemoryStateBackend:</p>

<ul>
  <li>The size of each individual state is by default limited to 5 MB. This value can be increased in the constructor of the MemoryStateBackend.</li>
  <li>Irrespective of the configured maximal state size, the state cannot be larger than the akka frame size (see <a href="/setup/config.html">Configuration</a>).</li>
  <li>The aggregate state must fit into the JobManager memory.</li>
</ul>

<p>The MemoryStateBackend is encouraged for:</p>

<ul>
  <li>Local development and debugging</li>
  <li>Jobs that do hold little state, such as jobs that consist only of record-at-a-time functions (Map, FlatMap, Filter, …). The Kafka Consumer requires very little state.</li>
</ul>

<h3 id="the-fsstatebackend">The FsStateBackend</h3>

<p>The <em>FsStateBackend</em> is configured with a file system URL (type, address, path), such as for example “hdfs://namenode:40010/flink/checkpoints” or “file:///data/flink/checkpoints”.</p>

<p>The FsStateBackend holds in-flight data in the TaskManager’s memory. Upon checkpointing, it writes state snapshots into files in the configured file system and directory. Minimal metadata is stored in the JobManager’s memory (or, in high-availability mode, in the metadata checkpoint).</p>

<p>The FsStateBackend is encouraged for:</p>

<ul>
  <li>Jobs with large state, long windows, large key/value states.</li>
  <li>All high-availability setups.</li>
</ul>

<h3 id="the-rocksdbstatebackend">The RocksDBStateBackend</h3>

<p>The <em>RocksDBStateBackend</em> is configured with a file system URL (type, address, path), such as for example “hdfs://namenode:40010/flink/checkpoints” or “file:///data/flink/checkpoints”.</p>

<p>The RocksDBStateBackend holds in-flight data in a <a href="http://rocksdb.org">RocksDB</a> data base
that is (per default) stored in the TaskManager data directories. Upon checkpointing, the whole
RocksDB data base will be checkpointed into the configured file system and directory. Minimal
metadata is stored in the JobManager’s memory (or, in high-availability mode, in the metadata checkpoint).</p>

<p>The RocksDBStateBackend is encouraged for:</p>

<ul>
  <li>Jobs with very large state, long windows, large key/value states.</li>
  <li>All high-availability setups.</li>
</ul>

<p>Note that the amount of state that you can keep is only limited by the amount of disc space available.
This allows keeping very large state, compared to the FsStateBackend that keeps state in memory.
This also means, however, that the maximum throughput that can be achieved will be lower with
this state backend.</p>

<p><strong>NOTE:</strong> To use the RocksDBStateBackend you also have to add the correct maven dependency to your
project:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.apache.flink<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>flink-statebackend-rocksdb_2.10<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>1.1-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre></figure>

<p>The backend is currently not part of the binary distribution. See
<a href="/apis/cluster_execution.html#linking-with-modules-not-contained-in-the-binary-distribution">here</a>
for an explanation of how to include it for cluster execution.</p>

<h2 id="configuring-a-state-backend">Configuring a State Backend</h2>

<p>State backends can be configured per job. In addition, you can define a default state backend to be used when the
job does not explicitly define a state backend.</p>

<h3 id="setting-the-per-job-state-backend">Setting the Per-job State Backend</h3>

<p>The per-job state backend is set on the <code>StreamExecutionEnvironment</code> of the job, as shown in the example below:</p>

<div class="codetabs">
  <div data-lang="java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">StreamExecutionEnvironment</span> <span class="n">env</span> <span class="o">=</span> <span class="n">StreamExecutionEnvironment</span><span class="o">.</span><span class="na">getExecutionEnvironment</span><span class="o">();</span>
<span class="n">env</span><span class="o">.</span><span class="na">setStateBackend</span><span class="o">(</span><span class="k">new</span> <span class="nf">FsStateBackend</span><span class="o">(</span><span class="s">&quot;hdfs://namenode:40010/flink/checkpoints&quot;</span><span class="o">));</span></code></pre></figure>

  </div>
  <div data-lang="scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">env</span> <span class="k">=</span> <span class="nc">StreamExecutionEnvironment</span><span class="o">.</span><span class="n">getExecutionEnvironment</span><span class="o">()</span>
<span class="n">env</span><span class="o">.</span><span class="n">setStateBackend</span><span class="o">(</span><span class="k">new</span> <span class="nc">FsStateBackend</span><span class="o">(</span><span class="s">&quot;hdfs://namenode:40010/flink/checkpoints&quot;</span><span class="o">))</span></code></pre></figure>

  </div>
</div>

<h3 id="setting-default-state-backend">Setting Default State Backend</h3>

<p>A default state backend can be configured in the <code>flink-conf.yaml</code>, using the configuration key <code>state.backend</code>.</p>

<p>Possible values for the config entry are <em>jobmanager</em> (MemoryStateBackend), <em>filesystem</em> (FsStateBackend), or the fully qualified class
name of the class that implements the state backend factory <a href="https://github.com/apache/flink/blob/master/flink-runtime/src/main/java/org/apache/flink/runtime/state/filesystem/FsStateBackendFactory.java">FsStateBackendFactory</a>.</p>

<p>In the case where the default state backend is set to <em>filesystem</em>, the entry <code>state.backend.fs.checkpointdir</code> defines the directory where the checkpoint data will be stored.</p>

<p>A sample section in the configuration file could look as follows:</p>

<div class="highlight"><pre><code># The backend that will be used to store operator state checkpoints

state.backend: filesystem


# Directory for storing checkpoints

state.backend.fs.checkpointdir: hdfs://namenode:40010/flink/checkpoints
</code></pre></div>

      <div class="footer">
      发现错误？想参与编辑？
      <a href="https://github.com/wuchong/flink-china-doc/edit/master/apis/streaming/state_backends.md" target="_blank">
        在 Github 上编辑此页！
      </a>
    </div>
    </div>
  </div>

  
</div>

    </div><!-- /.container -->

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="//cdn.bootcss.com/jquery/1.11.2/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="//cdn.bootcss.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="//cdn.bootcss.com/anchor-js/3.1.0/anchor.min.js"></script>
    <script src="/page/js/flink.js"></script>

    <!-- Google Analytics -->
    <!-- script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-52545728-1', 'auto');
      ga('send', 'pageview');
    </script -->

    <!-- Baidu Analytics -->
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?835985ad7943d8c24bc3c1f155b7d4a2";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
    </script>


    <!-- Disqus -->
    
  </body>
</html>
